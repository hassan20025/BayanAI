<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Chatbot Activity - bayanAI</title>
  <link rel="stylesheet" href="style.css" />
  <link rel="stylesheet" href="chatbot.css" />
</head>
<body>
  <div class="dashboard-main">
    <div class="interactions-header" style="margin-top: 2rem; margin-bottom: 1.5rem; display: flex; align-items: center; justify-content: space-between; width: 100%;">
      <h2 style="color: var(--heading-color, #fff);">Chatbot Activity</h2>
    </div>
    <div class="interactions-table-container">
      <table class="interactions-table">
        <colgroup>
          <col style="width: 8%;" />
          <col style="width: 20%;" />
          <col style="width: 18%;" />
          <col style="width: 18%;" />
          <col style="width: 18%;" />
          <col style="width: 18%;" />
        </colgroup>
        <thead>
          <tr>
            <th>ID</th>
            <th>Company</th>
            <th>Total Messages</th>
            <th>Users Added</th>
            <th>Failed Responses</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody id="chats-table-body">
          <!-- Chats will be loaded from database -->
        </tbody>
      </table>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Chat management functions
      async function loadChatsFromDB() {
        console.log('Loading chats from database...');
        
        const chatsTableBody = document.getElementById('chats-table-body');
        
        if (!chatsTableBody) {
          console.error('Chats table body not found');
          return;
        }
        
        try {
          const res = await fetch('../api/getChats.php');
          console.log('Response status:', res.status);
          const chats = await res.json();
          console.log('Chats received:', chats);
          console.log('Chats type:', typeof chats);
          console.log('Is array:', Array.isArray(chats));

          // Handle both array and object responses
          let chatsArray = chats;
          if (!Array.isArray(chats)) {
            console.error('Expected array but got:', typeof chats);
            if (chats.error) {
              console.error('Error from server:', chats.error);
              return;
            }
            // If it's a single object, wrap it in an array
            chatsArray = [chats];
          }

          chatsTableBody.innerHTML = ''; // clear existing rows

          chatsArray.forEach(chat => {
            const row = document.createElement('tr');
            row.innerHTML = `
              <td>${chat.id}</td>
              <td>${chat.company_name}</td>
              <td>${chat.total_messeges.toLocaleString()}</td>
              <td>${chat.users_added}</td>
              <td>${chat.failed_responses}</td>
              <td>
                <div class="action-buttons">
                                     <button class="icon-button flag-action" title="Flag">
                     <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                       <path d="M4 22V4a2 2 0 0 1 2-2h11.5a1.5 1.5 0 0 1 1.4 2.1L17 7l1.9 4.9A1.5 1.5 0 0 1 17.5 15H6a2 2 0 0 1-2-2z"/>
                     </svg>
                   </button>
                  <button class="icon-button export-action" title="Export">
                    <img src="export.svg" alt="Export" style="width: 20px; height: 20px; filter: brightness(0) invert(1);">
                  </button>

                </div>
              </td>
            `;
            chatsTableBody.appendChild(row);
          });

          console.log('Chats loaded successfully:', chatsArray.length);

        } catch (err) {
          console.error("Failed to load chats:", err);
        }
      }

      // Function to refresh the table
      async function refreshChatsTable() {
        await loadChatsFromDB();
      }

      // Setup export functionality
      function setupExportFunctionality() {
        const chatsTableBody = document.getElementById('chats-table-body');
        if (chatsTableBody) {
          chatsTableBody.addEventListener('click', async function (e) {
            if (e.target.closest('.export-action')) {
              const row = e.target.closest('tr');
              const chatId = row.children[0].textContent;
              const companyName = row.children[1].textContent;
              const totalMessages = row.children[2].textContent;
              const usersAdded = row.children[3].textContent;
              const failedResponses = row.children[4].textContent;

              // Create detailed report format
              const currentDate = new Date().toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
              });
              
              // Calculate success rate
              const successRate = totalMessages > 0 ? Math.round(((totalMessages - failedResponses) / totalMessages) * 100) : 0;
              
              const csvContent = `Chatbot Activity Report
Generated: ${currentDate}
Company: ${companyName}
Chat ID: ${chatId}

ID,Company Name,Total Messages,Users Added,Failed Responses,Success Rate (%)
${chatId},"${companyName}",${totalMessages},${usersAdded},${failedResponses},${successRate}

Notes:
- Total Messages: ${totalMessages}
- Users Added: ${usersAdded}
- Failed Responses: ${failedResponses}
- Success Rate: ${successRate}%
- Export Date: ${currentDate}`;
              
              // Create and download CSV file
              const blob = new Blob([csvContent], { type: 'text/csv' });
              const url = window.URL.createObjectURL(blob);
              const a = document.createElement('a');
              a.href = url;
              a.download = `chatbot-activity-${companyName}-${new Date().toISOString().split('T')[0]}.csv`;
              document.body.appendChild(a);
              a.click();
              document.body.removeChild(a);
              window.URL.revokeObjectURL(url);
              
              console.log("Chat data exported successfully");
            }
          });
        }
      }

      // Load chats and setup functionality
      loadChatsFromDB();
      setupExportFunctionality();
    });
  </script>
  <script src="chatbot.js"></script>
</body>
</html> 