<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Knowledge Base - bayanAI</title>
  <link rel="stylesheet" href="style.css"/>
  <link rel="stylesheet" href="knowledge.css"/>
  <!-- <script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script> -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@sweetalert2/theme-dark@5/dark.css">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.js"></script>
</head>
<body>
  <div class="dashboard-layout">
    <aside class="sidebar">
      <div class="sidebar-logo">
        <svg class="sidebar-logo-icon" xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M7 3h6l5 5v13a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2z"/><polyline points="16 3 16 8 21 8"/><line x1="9" y1="13" x2="15" y2="13"/><line x1="9" y1="17" x2="15" y2="17"/></svg>
        <span class="sidebar-logo-text">bayanAI</span>
      </div>
      <nav class="sidebar-nav">
        <ul>
          <li><a href="index.html">Dashboard</a></li>
          <li><a href="users.html">Users</a></li>
          <li><a href="messeges.html">Messages</a></li>
          <li><a href="knowledge.html" class="active">Knowledge Base</a></li>
          <li><a href="/bayanai/chat/">Chat</a></li>
          <li><a href="settings.html">Settings</a></li>
        </ul>
      </nav>
    </aside>

    <div class="dashboard-main no-padding">
      <header class="dashboard-header">
        <h2 class="dashboard-title">Knowledge Base</h2>
        <div class="header-center">
          <div class="search-bar">
            <svg class="search-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor">
              <circle cx="11" cy="11" r="8" />
              <path d="m21 21-4.3-4.3" />
            </svg>
            <input type="search" placeholder="Search..." class="search-input"/>
          </div>
        </div>

        <div class="header-right">
          <button class="icon-button">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor">
              <path d="M6 8a6 6 0 0 1 12 0c0 7 3 9 3 9H3s3-2 3-9"/>
              <path d="M10.3 21a1.94 1.94 0 0 0 3.4 0"/>
            </svg>
          </button>

          <div class="user-dropdown">
            <button class="user-button">
              <div class="user-avatar">
                <svg class="user-avatar-svg" xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <circle cx="12" cy="8" r="4"/>
                  <path d="M4 20c0-2.5 3.5-4 8-4s8 1.5 8 4"/>
                </svg>
              </div>
              <div class="user-info" style="align-items: flex-start;">
                <span class="user-name">John Cario</span>
                <span class="user-role">CEO</span>
              </div>
              <svg class="dropdown-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <path d="m6 9 6 6 6-6" />
              </svg>
            </button>
            <div class="dropdown-menu">
              <a href="#" id="logout-btn">Logout</a>
            </div>
          </div>
        </div>

        <button id="theme-toggle" class="icon-button theme-toggle-button" aria-label="Toggle theme">
          <svg id="sun-icon" class="lucide lucide-sun sun-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="12" cy="12" r="4"/>
            <path d="M12 2v2"/>
            <path d="M12 20v2"/>
            <path d="M4.93 4.93l1.41 1.41"/>
            <path d="M17.66 17.66l1.41 1.41"/>
            <path d="M2 12h2"/>
            <path d="M20 12h2"/>
            <path d="M6.34 17.66l-1.41 1.41"/>
            <path d="M19.07 4.93l-1.41 1.41"/>
          </svg>
          <svg id="moon-icon" class="lucide lucide-moon moon-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"/>
          </svg>
        </button>
      </header>

      <div class="dashboard-main">
        <h2 style="color: var(--heading-color, #fff); margin: 2rem 0 1rem 0; text-align: center;">Knowledge Base</h2>

        <div class="interactions-header" style="margin-top: 2rem; margin-bottom: 1.5rem; display:flex; align-items:center; justify-content:space-between;">
          <div class="interaction-buttons">
            <button class="filter-button active">All Files</button>
            <button class="filter-button">PDFs</button>
            <button class="filter-button">Docs</button>
            <button class="filter-button">Images</button>
          </div>
          <div class="interaction-actions">
            <button class="icon-button" id="kb-filter-btn" title="Filter">
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 3H2l8 9.46V19l4 2v-8.54L22 3Z"/></svg>
            </button>
            <button class="settings-btn" id="openUploadModalButton">Add File</button>
          </div>
        </div>

        <div class="interactions-table-container" style="margin-inline: 10px;">
          <table class="interactions-table">
            <colgroup>
              <col style="width: 35%;">
              <col style="width: 15%;">
              <col style="width: 15%;">
              <col style="width: 20%;">
              <col style="width: 15%;">
            </colgroup>
            <thead>
              <tr>
                <th>File Name</th>
                <th>Type</th>
                <th>Size</th>
                <th>Date Added</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody id="kb-table-body">
              <!-- populated by JS -->
            </tbody>
          </table>
        </div>
        <div id="pagination" class="pagination"></div>
      </div> <!-- end inner dashboard-main -->
    </div> <!-- end dashboard-main no-padding -->
  </div> <!-- end dashboard-layout -->

  <div id="uploadModal" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-header">
            <h2 id="modalTitle">Upload Documents</h2>
            <button class="modal-close-button" id="closeUploadModalButton" aria-label="Close upload modal">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="18" y1="6" x2="6" y2="18"/>
                    <line x1="6" y1="6" x2="18" y2="18"/>
                </svg>
            </button>
        </div>

        <div class="modal-body">
            <!-- Upload Form (Initial State) -->
            <div id="uploadForm">
                <div class="upload-area">
                    <p>Drag & drop your files here, or click to browse.</p>
                    <input type="file" id="fileInput" multiple accept=".pdf,.txt,.png,.jpg,.jpeg" style="display: none;">
                    <button class="upload-button" id="browseFilesButton">Browse Files</button>
                    <div id="fileList" class="file-list"></div>
                </div>
                <p class="modal-info">Supported formats: PDF, TXT, PNG, JPG, JPEG.</p>
            </div>

            <!-- Upload Success (Hidden Initially) -->
            <div id="uploadSuccess" class="upload-success hidden">
                <div class="success-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="20,6 9,17 4,12"/>
                    </svg>
                </div>
                <h3 class="success-title">Upload Successful!</h3>
                <p class="success-message">Your files have been uploaded and are being processed. You'll be notified once they're ready for use.</p>
                
                <div class="uploaded-files-list">
                    <div class="uploaded-files-title">Uploaded Files</div>
                    <div id="uploadedFilesList"></div>
                </div>

                <div class="success-actions">
                    <button class="success-button secondary" id="uploadMoreButton">Upload More</button>
                    <button class="success-button primary" id="continueButton">Continue</button>
                </div>
            </div>
        </div>

        <div class="modal-footer" id="modalFooter">
          <button class="modal-action-button" style="display: flex; justify-content: center; align-items: center;" id="startUploadButton">
            <span class="button-text">Start Upload</span>
            <div class="spinner"></div>
          </button>
        </div>
      </div>
    </div>

  <!-- single hidden file input -->
  <input type="file" id="kb-file-input" style="display: none;" />

  <script>
    const API_BASE = '../api';

    function fmtSize(bytes) {
      bytes = Number(bytes) || 0;
      if (bytes >= 1073741824) return (bytes / 1073741824).toFixed(1) + ' GB';
      if (bytes >= 1048576)    return (bytes / 1048576).toFixed(1) + ' MB';
      if (bytes >= 1024)       return (bytes / 1024).toFixed(1) + ' KB';
      return bytes + ' B';
    }

    async function loadKB(page = 1) {
      const tbody = document.getElementById('kb-table-body');
      tbody.innerHTML = '<tr><td colspan="5" style="padding:16px;color:var(--text-muted,#94a3b8)">Loading…</td></tr>';
      
      try {
        const url = `${API_BASE}/getKnowledgeBase.php?page=${page}&size=10`;
        const res = await fetch(url);
        const pageData = await res.json();
        const data = pageData.files;
        
        console.log(pageData);
        
        if (!Array.isArray(data) || data.length === 0) {
          tbody.innerHTML = '<tr><td colspan="5" style="padding:16px;color:var(--text-muted,#94a3b8)">No files yet</td></tr>';
          // Hide pagination if no results
          document.getElementById('pagination').innerHTML = '';
          return;
        }
        
        tbody.innerHTML = data.map(f => {
          const id   = f.id || '';
          const name = f.file_name || '';
          const type = (f.file_type || '').toUpperCase();
          const size = f.size_label || fmtSize(f.size_bytes);
          const date = (f.created_at || '').slice(0, 10);

          let dataType = 'other';
          if (type.match(/\.?(PDF)$/i)) {
              dataType = 'pdf';
          } else if (type.match(/\.?(DOC|DOCX|TXT|RTF|ODT)$/i)) {
              dataType = 'doc';
          } else if (type.match(/\.?(JPG|JPEG|PNG|GIF|SVG|WEBP)$/i)) {
              dataType = 'image';
          }

          return `
            <tr data-id="${id}" data-name="${name}" data-type="${dataType}">
              <td>${name}</td>
              <td>${type}</td>
              <td>${size}</td>
              <td>${date}</td>
              <td>
                <div class="row-actions">
                  <button class="icon-button flag-action" title="Flag">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 22V4a2 2 0 0 1 2-2h11.5a1.5 1.5 0 0 1 1.4 2.1L17 7l1.9 4.9A1.5 1.5 0 0 1 17.5 15H6a2 2 0 0 1-2-2z"/></svg>
                  </button>
                  <button class="icon-button delete-action" title="Delete">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg>
                  </button>
                </div>
              </td>
            </tr>`;
        }).join('');
        
        // Update pagination if the API provides pagination info
        console.log(pageData);
        if (pageData.has_more !== undefined || pageData.total_pages !== undefined) {
          const hasMore = pageData.has_more;
          totalPages = pageData.total_pages || Math.ceil(pageData.total / pageData.size) || 1;
          currentPage = page;
          
          renderPagination();
        }
      } catch (e) {
        console.error(e);
        tbody.innerHTML = '<tr><td colspan="5" style="padding:16px;color:#ef4444">Failed to load files</td></tr>';
        document.getElementById('pagination').innerHTML = '';
      }
    }

    function renderPagination() {
      console.log(totalPages);
      const paginationContainer = document.getElementById('pagination');
      
      // Don't show pagination if there's only one page
      if (totalPages <= 1) {
        paginationContainer.innerHTML = '';
        return;
      }
      
      let paginationHTML = '';
      
      // Previous button
      paginationHTML += `
        <button class="pagination-button" ${currentPage <= 1 ? 'disabled' : ''} data-page="${currentPage - 1}">
          <
        </button>
      `;
      
      // Page numbers
      const maxVisiblePages = 3;
      let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
      let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
      
      // Adjust if we're near the end
      if (endPage - startPage + 1 < maxVisiblePages) {
        startPage = Math.max(1, endPage - maxVisiblePages + 1);
      }
      
      // First page and ellipsis if needed
      if (startPage > 1) {
        paginationHTML += `
          <button class="pagination-button" data-page="1">1</button>
          ${startPage > 2 ? '<span class="pagination-ellipsis">...</span>' : ''}
        `;
      }
      
      // Page numbers
      for (let i = startPage; i <= endPage; i++) {
        paginationHTML += `
          <button class="pagination-button ${i === currentPage ? 'active' : ''}" data-page="${i}">
            ${i}
          </button>
        `;
      }
      
      // Last page and ellipsis if needed
      if (endPage < totalPages) {
        paginationHTML += `
          ${endPage < totalPages - 1 ? '<span class="pagination-ellipsis">...</span>' : ''}
          <button class="pagination-button" data-page="${totalPages}">${totalPages}</button>
        `;
      }
      
      // Next button
      paginationHTML += `
        <button class="pagination-button" ${currentPage >= totalPages ? 'disabled' : ''} data-page="${currentPage + 1}">
          >
        </button>
      `;
      
      // Page info
      // paginationHTML += `
      //   <span class="pagination-info">Page ${currentPage} of ${totalPages}</span>
      // `;
      
      paginationContainer.innerHTML = paginationHTML;
      
      // Add event listeners to pagination buttons
      paginationContainer.querySelectorAll('.pagination-button:not([disabled])').forEach(button => {
        button.addEventListener('click', () => {
          const page = parseInt(button.getAttribute('data-page'));
          if (page && page !== currentPage) {
            loadKB(page);
          }
        });
      });
    }


    // Modal functionality
    const uploadModal = document.getElementById('uploadModal');
    const openUploadModalButton = document.getElementById('openUploadModalButton');
    const closeUploadModalButton = document.getElementById('closeUploadModalButton');
    const browseFilesButton = document.getElementById('browseFilesButton');
    const fileInput = document.getElementById('fileInput');
    const fileList = document.getElementById('fileList');
    const startUploadButton = document.getElementById('startUploadButton');
    const continueButton = document.getElementById('continueButton');
    const uploadMoreButton = document.getElementById('uploadMoreButton');
    const kbFileInput = document.getElementById('kb-file-input');
    const kbTableBody = document.getElementById("kb-table-body");

    let selectedFiles = [];

    function openModal() {
      document.getElementById("startUploadButton").classList.remove("loading");
      uploadModal.classList.add('visible');
      document.body.style.overflow = 'hidden';
    }

    function closeModal() {
      uploadModal.classList.remove('visible');
      document.body.style.overflow = '';
      resetModal();
    }

    function resetModal() {
      document.getElementById('modalTitle').textContent = 'Upload Documents';
      document.getElementById('uploadForm').classList.remove('hidden');
      document.getElementById('uploadSuccess').classList.add('hidden');
      document.getElementById('modalFooter').classList.remove('hidden');
      fileList.innerHTML = '';
      fileInput.value = '';
      startUploadButton.disabled = true;
      selectedFiles = [];
    }

    function uploadMore() {
      resetModal();
    }

    function displayFileList(files) {
      fileList.innerHTML = '';
      files.forEach(file => {
        const fileItem = document.createElement('div');
        fileItem.className = 'file-item';
        fileItem.textContent = file.name;
        fileList.appendChild(fileItem);
      });
    }

    function displayUploadedFiles(files) {
      const uploadedFilesList = document.getElementById('uploadedFilesList');
      uploadedFilesList.innerHTML = '';

      files.forEach(file => {
        const fileItem = document.createElement('div');
        fileItem.className = 'uploaded-file-item';
        
        fileItem.innerHTML = `
          <svg class="file-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/>
            <polyline points="14 2 14 8 20 8"/>
          </svg>
          <span class="file-name">${file.name}</span>
          <span class="file-status">✓ Uploaded</span>
        `;
        
        uploadedFilesList.appendChild(fileItem);
      });
    }


    async function startUpload(e) {
      e.preventDefault();
      if (selectedFiles.length === 0) return;

      const formData = new FormData();
      for (let i = 0; i < selectedFiles.length; i++) {
        formData.append('files[]', selectedFiles[i]);
      }

      try {
        e.target.classList.add("loading");
        e.currentTarget.classList.add("loading");
        const response = await fetch(`${API_BASE}/documentChunks/upload.php`, {
          method: 'POST',
          body: formData
        });
        
        const result = await response.json();
        
        if (result.status === "success") {
          closeModal();
          Swal.fire({
            icon: "success",
            title: "Success",
            text: `Files uploaded successfully`,
          });
          
          await loadKB();
        } else {
          throw new Error(result.error || 'Upload failed');
        }
      } catch (error) {
        console.log(error);
        Swal.fire({
            icon: "error",
            title: "Error",
            text: `Failed to upload files`,
        });
        console.error('Upload failed:', error);
      }
      finally {
        e.currentTarget.classList.remove("loading");
        e.target.classList.remove("loading");
      }
    }

    openUploadModalButton.addEventListener('click', openModal);
    closeUploadModalButton.addEventListener('click', closeModal);
    uploadModal.addEventListener('click', (e) => {
      if (e.target === uploadModal) closeModal();
    });
    browseFilesButton.addEventListener('click', () => fileInput.click());
    fileInput.addEventListener('change', (e) => {
      selectedFiles = Array.from(e.target.files);
      displayFileList(selectedFiles);
      startUploadButton.disabled = selectedFiles.length === 0;
    });
    startUploadButton.addEventListener('click', startUpload);
    continueButton.addEventListener('click', closeModal);
    uploadMoreButton.addEventListener('click', uploadMore);

    // Original KB functionality
    kbTableBody.onclick = async function(e) {
  const flagBtn = e.target.closest('.flag-action');
  const delBtn  = e.target.closest('.delete-action');
  const row     = e.target.closest('tr');
  if (!row) return;

  if (flagBtn) {
    flagBtn.classList.toggle('flagged');
    return;
  }

  if (delBtn) {
    const id   = row.getAttribute('data-id');
    const name = row.getAttribute('data-name') || row.children[0]?.textContent?.trim();

    // Show SweetAlert2 confirmation
    const result = await Swal.fire({
      title: "Are you sure?",
      text: `Delete "${name}"?`,
      icon: "warning",
      showCancelButton: true,
      confirmButtonColor: "#d33",
      cancelButtonColor: "#3085d6",
      confirmButtonText: "Yes, delete it!",
      cancelButtonText: "Cancel"
    });

    if (!result.isConfirmed) return;

    try {
      const res = await fetch(`${API_BASE}/deleteKnowledgeFile.php`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: new URLSearchParams(id ? { id } : { file_name: name })
      });

      const text = await res.text();
      let out;
      try { 
        out = JSON.parse(text); 
      } catch { 
        throw new Error(text.slice(0,200)); 
      }

      if (!res.ok || out.success === false) {
        throw new Error(out.error || 'Delete failed');
      }

      // Success popup
      await Swal.fire({
        title: "Deleted!",
        text: `"${name}" has been removed.`,
        icon: "success",
        confirmButtonText: "OK"
      });
      
      row.remove();

    } catch (err) {
      // Error popup
      await Swal.fire({
        title: "Error",
        text: "Delete error: " + err.message,
        icon: "error",
        confirmButtonText: "OK"
      });
    }
  }
};

    document.addEventListener('DOMContentLoaded', function() {
    // Get all filter buttons
    const filterButtons = document.querySelectorAll('.filter-button');
    const kbTableBody = document.getElementById('kb-table-body');
    
    // Current filter state
    let currentFilter = 'all';
    let currentSearch = '';
    
    // Add click event listeners to filter buttons
    filterButtons.forEach(button => {
        button.addEventListener('click', function() {
            // Remove active class from all buttons
            filterButtons.forEach(btn => btn.classList.remove('active'));
            
            // Add active class to clicked button
            this.classList.add('active');
            
            // Set current filter based on button text
            currentFilter = this.textContent.trim().toLowerCase();
            if (currentFilter === 'all files') currentFilter = 'all';
            
            // Filter the table
            filterTable();
        });
    });
    
    // Function to filter the table
    function filterTable() {
        const rows = kbTableBody.querySelectorAll('tr');
        
        console.log(currentFilter)
        rows.forEach(row => {
            const fileName = row.querySelector('td:first-child')?.textContent?.toLowerCase() || '';
            // const fileType = row.querySelector('td:nth-child(2)')?.textContent?.toLowerCase() || '';
            const fileType = row.getAttribute('data-type') || '';
            console.log(fileType);
            const shouldShow = 
            (currentFilter === 'all' || 
              (currentFilter === 'pdfs' && fileType === 'pdf') ||
              (currentFilter === 'docs' && fileType === 'doc') ||
              (currentFilter === 'images' && fileType === 'image'));
            
            row.style.display = shouldShow ? '' : 'none';
        });
    }
    
    loadKB();
});

    
  </script>
  <script src="script.js"></script>
  <style>
    /* action icons like users.html */
    .row-actions { display:flex; gap:.5rem; align-items:center; }
    .icon-button { display:inline-flex; align-items:center; justify-content:center; width:34px; height:34px; border-radius:8px; background:var(--card-bg-lighter,#334155); border:1px solid var(--border-color,#2d3748); cursor:pointer; }
    .icon-button:hover { background:var(--card-bg,#1f2937); }
    .icon-button svg { width:20px; height:20px; }
    .flag-action.flagged svg { color:#f59e0b; stroke:#f59e0b; } /* amber like users */
  </style>
</body>
</html>